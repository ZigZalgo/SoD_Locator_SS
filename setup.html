<!DOCTYPE html>
<html>
<head>
    <title>Super Cool SOD Visualizer</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">
        var cameraHeightInPixels = 320;
        var cameraWidthInPixels = 480;
        var cameraFOV = 57;

        function drawGrid() {
            var cnv = document.getElementById("cnvBG");

            var gridOptions = {
                minorLines: {
                    separation: 20,
                    color: '#EEEEEE'
                },
                majorLines: {
                    separation: 100,
                    color: '#BBBBBB'
                }
            };

            drawGridLines(cnv, gridOptions.minorLines);
            drawGridLines(cnv, gridOptions.majorLines);

            return;
        }

        function drawGridLines(cnv, lineOptions) {
            var iWidth = cnv.width;
            var iHeight = cnv.height;
            var ctx = cnv.getContext('2d');

            ctx.strokeStyle = lineOptions.color;
            ctx.strokeWidth = 1;

            ctx.beginPath();

            var iCount = null;
            var i = null;
            var x = null;
            var y = null;

            iCount = Math.floor(iWidth / lineOptions.separation);

            for (i = 1; i <= iCount; i++) {
                x = (i * lineOptions.separation);
                ctx.moveTo(x, 0);
                ctx.lineTo(x, iHeight);
                ctx.stroke();
            }

            iCount = Math.floor(iHeight / lineOptions.separation);

            for (i = 1; i <= iCount; i++) {
                y = (i * lineOptions.separation);
                ctx.moveTo(0, y);
                ctx.lineTo(iWidth, y);
                ctx.stroke();
            }

            ctx.closePath();
            return;
        }

        function shiftXToGridOrigin(x){
            return (x + ((document.getElementById("cnv").width)/2));
        }

        function shiftYToGridOrigin(z){
            return (z + ((document.getElementById("cnv").height)/2));
        }

        io = io.connect()

        function updateCanvasWithSensors(){
            ////
            var sensorX = 0; //get this from sensor list later on
            var sensorY = 0; //get this from sensor list later on
            var sensorRotationAngle = 0; //get this from sensor list later on
            var sensorFOV = 57; //get this from sensor list later on
            ////
            var radius = 400; //how long are the view lines? in pixels...

            //Calculate polygon for FOV indicator on visualizer
            var viewPoint1X = (radius)*(Math.sin((sensorRotationAngle + (sensorFOV/2))*Math.PI/180));
            var viewPoint1Y = (radius)*(Math.cos((sensorRotationAngle + (sensorFOV/2))*Math.PI/180));
            var viewPoint2X = (radius)*(Math.sin((sensorRotationAngle - (sensorFOV/2))*Math.PI/180));
            var viewPoint2Y = (radius)*(Math.cos((sensorRotationAngle - (sensorFOV/2))*Math.PI/180));

            //Get Context for drawing on HTML5 Canvas
            var cBG = document.getElementById("cnvBG");
            var ctxBG = cBG.getContext("2d");

            //draw view polygon
            ctxBG.fillStyle = "rgba(0, 0, 0, 0.2)";
            ctxBG.beginPath();
            ctxBG.moveTo(shiftXToGridOrigin(sensorX), shiftYToGridOrigin(sensorY));  //move to Kinect coordinates
            ctxBG.lineTo(shiftXToGridOrigin(viewPoint1X), shiftYToGridOrigin(viewPoint1Y));
            ctxBG.lineTo(shiftXToGridOrigin(viewPoint2X), shiftYToGridOrigin(viewPoint2Y));
            ctxBG.closePath();
            ctxBG.fill();

            //draw circle for sensor on visualizer
            ctxBG.beginPath();
            ctxBG.arc(shiftXToGridOrigin(sensorX), shiftYToGridOrigin(sensorY),40,0,2*Math.PI);
            ctxBG.stroke();

            //$('#content2').append('<p> ' + 'ViewPoint1X: ' + viewPoint1X + 'ViewPoint1Y: ' + viewPoint1Y + 'ViewPoint2X: ' + viewPoint2X + 'ViewPoint2Y: ' + viewPoint2Y +'</p>')
        }

        function updateCanvasWithPeople(){
            io.emit('getPeopleFromServer', {}, function(data){
                //draw kinect position (0,0) for single kinect
                var c = document.getElementById("cnv");
                var ctx = c.getContext("2d");
                ctx.clearRect(0, 0, c.width, c.height);

                data.forEach(function(person){

                    var xInMeters = person.Location.X*100;
                    var yInMeters = person.Location.Y*100;
                    var zInMeters = person.Location.Z*100;

                    ctx.beginPath();
                    ctx.arc(shiftXToGridOrigin(xInMeters),shiftYToGridOrigin(zInMeters),10,0,2*Math.PI);
                    ctx.strokeStyle = "rgba(200, 0, 0, 0.8)";
                    ctx.stroke();
                    //$('body').append('<p>New visitor, hooray! ' + data +'</p>')

                    ctx.font = "30px Arial";
                    ctx.fillText(person.ID,shiftXToGridOrigin(xInMeters),shiftYToGridOrigin(zInMeters)+30);
                })
            });
        }

        function updateContentWithObjects(){
            $('#content').html('<b>Updates...</b>');
            io.emit('getSensorsFromServer', {}, function(data){
                $('#content').append('<div >Sensors:'+JSON.stringify(data)+'</div>'); /*appending the data on the page using Jquery */
            });
            io.emit('getPeopleFromServer', {}, function(data){
                $('#content').append('<div >People:'+JSON.stringify(data)+'</div>'); /*appending the data on the page using Jquery */
            });
            io.emit('getDevicesWithSelection', {additionalInfo: {selection: "all"}}, function(data){
                $('#content').append('<div >Devices:'+JSON.stringify(data)+'</div>'); /*appending the data on the page using Jquery */
            });
        }

        io.on("webMessageEvent",function(message){
            message = JSON.parse(message);
            $('#content').append('<div >'+message.data+'</div>'); /*appending the data on the page using Jquery */
        });
        $(function(){
            $('#getSensors').click(function(){ /*listening to the button click using Jquery listener*/
                io.emit('getSensorsFromServer', {}, function(data){
                    $('#content').val('');
                    $('#content').append('<div >'+data+'</div>'); /*appending the data on the page using Jquery */
                });
            });

            $('#getPeople').click(function(){ /*listening to the button click using Jquery listener*/
                io.emit('getPeopleFromServer', {}, function(data){
                    $('#content').val('');
                    $('#content').append('<div >'+data+'</div>'); /*appending the data on the page using Jquery */
                });
            });

            $('#getDevices').click(function(){ /*listening to the button click using Jquery listener*/
                io.emit('getDevicesWithSelection', {additionalInfo: {selection: "all"}}, function(data){
                    $('#content').val('');
                    $('#content').append('<div >'+data+'</div>'); /*appending the data on the page using Jquery */
                });
            });
        });

        setInterval(function() {updateCanvasWithPeople(); }, 200); //poll server for people list and display on canvas
        setInterval(function() {updateContentWithObjects(); }, 1000); //poll server for sensors, people, and devices and display to the side

    </script>
</head>
<body onload="drawGrid(); updateCanvasWithSensors();">
    <div>
        <canvas id="cnv" width="800" height="800"
                style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
        <canvas id="cnvBG" width="800" height="800"
                style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
    </div>
    <div style="position: absolute; left: 810px; top: 0;">
        <form>

            <!--<input type="text" id="message" /> <!--text form to send data to the server-->
            <!--<input id="getPeople" type="button" value="Not really used right now...">   -->
            <div id="content"></div> <!--This is where the data from the server is added-->
            <div id="content2"></div> <!--This is where the data from the server is added-->
            <div id="content3"></div> <!--This is where the data from the server is added-->

        </form>
    </div>
</body>
</html>